<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next Chess Best Move Calculator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jQuery (Required for chessboard.js) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- Chessboard.js -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    
    <!-- Chess.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #0f172a; /* slate-900 */
            color: #f8fafc; /* slate-50 */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Chessboard custom styling */
        .board-b72b1 {
            border: 4px solid #334155;
            border-radius: 4px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .white-1e1d7 { background-color: #e2e8f0; color: #475569; }
        .black-3c85d { background-color: #64748b; color: #e2e8f0; }

        /* Highlight squares */
        .highlight-white { background-color: rgba(52, 211, 153, 0.6) !important; }
        .highlight-black { background-color: rgba(16, 185, 129, 0.6) !important; }
        .highlight-best-from { background-color: rgba(59, 130, 246, 0.6) !important; }
        .highlight-best-to { background-color: rgba(37, 99, 235, 0.7) !important; }

        /* Loader animation */
        .loader {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        
        /* Adjust spare pieces margin */
        .spare-pieces-7492f { margin: 10px 0; display: flex; justify-content: space-around; background: #1e293b; padding: 10px; border-radius: 4px; border: 1px solid #334155;}
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-8">

    <header class="mb-6 flex items-center gap-3">
        <i class="fa-solid fa-chess-knight text-4xl text-blue-500"></i>
        <div>
            <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Next Chess Best Move Calculator</h1>
            <p class="text-sm text-slate-400">Advanced browser-based engine analysis with seamless editing</p>
        </div>
    </header>

    <main class="flex-grow flex flex-col lg:flex-row gap-8 max-w-7xl mx-auto w-full">
        
        <!-- Left Column: Chess Board -->
        <div class="w-full lg:w-[500px] flex-shrink-0 flex flex-col gap-4">
            <!-- The Board Container -->
            <div id="board" class="w-full"></div>
            
            <!-- Basic Controls -->
            <div class="grid grid-cols-3 gap-2 mt-2">
                <button id="btnStart" class="bg-slate-700 hover:bg-slate-600 transition-colors py-2 px-4 rounded text-sm font-semibold shadow flex items-center justify-center gap-2">
                    <i class="fa-solid fa-play"></i> Start Pos
                </button>
                <button id="btnClear" class="bg-slate-700 hover:bg-slate-600 transition-colors py-2 px-4 rounded text-sm font-semibold shadow flex items-center justify-center gap-2">
                    <i class="fa-solid fa-eraser"></i> Clear
                </button>
                <button id="btnFlip" class="bg-slate-700 hover:bg-slate-600 transition-colors py-2 px-4 rounded text-sm font-semibold shadow flex items-center justify-center gap-2">
                    <i class="fa-solid fa-retweet"></i> Flip
                </button>
            </div>
            
            <p class="text-xs text-slate-400 text-center mt-2"><i class="fa-solid fa-info-circle"></i> <b>Tip:</b> Drag from the spare pieces or drag off the board to instantly edit the position during play.</p>
        </div>

        <!-- Right Column: Analysis & Settings -->
        <div class="w-full flex flex-col gap-6">
            
            <!-- Main Actions -->
            <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-xl">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                    <div>
                        <h2 class="text-xl font-bold mb-1">Position Analysis</h2>
                        <div id="gameStatus" class="text-sm font-medium text-blue-400">White to move</div>
                    </div>
                    <button id="btnCalculate" class="bg-blue-600 hover:bg-blue-500 text-white transition-colors py-3 px-6 rounded-lg font-bold shadow-lg flex items-center gap-2 w-full sm:w-auto justify-center">
                        <i class="fa-solid fa-microchip"></i> Calculate Best Move
                    </button>
                    <button id="btnStop" class="bg-red-600 hover:bg-red-500 text-white transition-colors py-3 px-6 rounded-lg font-bold shadow-lg flex items-center gap-2 w-full sm:w-auto justify-center hidden">
                        <i class="fa-solid fa-stop"></i> Stop
                    </button>
                </div>

                <!-- Engine Output Display -->
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700 font-mono text-sm">
                    <div id="engineStatus" class="text-slate-500 italic mb-3">Idle. Click 'Calculate' or make a move.</div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <div class="text-xs text-slate-400 mb-1">EVALUATION</div>
                            <div id="evalScore" class="text-xl font-bold text-white">-</div>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <div class="text-xs text-slate-400 mb-1">DEPTH</div>
                            <div id="evalDepth" class="text-xl font-bold text-white">-</div>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700 col-span-2">
                            <div class="text-xs text-slate-400 mb-1">BEST MOVE</div>
                            <div id="evalBestMove" class="text-xl font-bold text-blue-400">-</div>
                        </div>
                    </div>

                    <div>
                        <div class="text-xs text-slate-400 mb-1">PRINCIPAL VARIATION (PV)</div>
                        <div id="evalPV" class="text-slate-300 leading-relaxed min-h-[2.5rem]">-</div>
                    </div>
                </div>
            </div>

            <!-- Settings & Setup -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Engine Settings -->
                <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-lg">
                    <h3 class="text-lg font-bold mb-4 border-b border-slate-700 pb-2"><i class="fa-solid fa-sliders text-slate-400 mr-2"></i>Engine Settings</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Time to Think (seconds)</label>
                            <input type="number" id="thinkTime" min="1" max="60" value="3" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Auto Calculate Position</label>
                            <select id="autoCalcSide" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                                <option value="off">Off (Manual)</option>
                                <option value="w">For White Only</option>
                                <option value="b">For Black Only</option>
                                <option value="both" selected>For Both Sides</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Auto Play Best Move</label>
                            <select id="autoPlaySide" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                                <option value="off" selected>Off (Observe Only)</option>
                                <option value="w">Play as White (Engine is White)</option>
                                <option value="b">Play as Black (Engine is Black)</option>
                                <option value="both">Play Both (Engine vs Engine)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Position Setup -->
                <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-lg">
                    <h3 class="text-lg font-bold mb-4 border-b border-slate-700 pb-2"><i class="fa-solid fa-cogs text-slate-400 mr-2"></i>Position Setup</h3>
                    
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-slate-300 mb-1">Side to Move</label>
                                <select id="turnSelect" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm font-bold text-white focus:outline-none focus:border-blue-500">
                                    <option value="w">White</option>
                                    <option value="b">Black</option>
                                </select>
                            </div>
                            <div class="flex-1 flex flex-col justify-center">
                                <label class="text-sm font-medium text-slate-300 mb-1">Enforce Chess Rules</label>
                                <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="enforceRules" id="enforceRules" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-400 focus:outline-none z-10" checked/>
                                    <label for="enforceRules" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-400 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Current FEN</label>
                            <input type="text" id="fenInput" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-xs font-mono text-slate-400 focus:outline-none" readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Set Custom FEN</label>
                            <div class="flex gap-2">
                                <input type="text" id="customFen" placeholder="Paste FEN here..." class="flex-grow bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                                <button id="btnSetFen" class="bg-slate-700 hover:bg-slate-600 transition-colors px-4 py-2 rounded text-sm font-semibold">Set</button>
                            </div>
                            <p id="fenError" class="text-red-400 text-xs mt-1 hidden">Invalid FEN string</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- App Logic -->
    <script>
        // --- GLOBALS & UI ELEMENTS ---
        let board = null;
        let game = new Chess();
        let engineWorker = null;
        let isCalculating = false;

        const $status = $('#gameStatus');
        const $fenInput = $('#fenInput');
        const $engineStatus = $('#engineStatus');
        const $evalScore = $('#evalScore');
        const $evalDepth = $('#evalDepth');
        const $evalBestMove = $('#evalBestMove');
        const $evalPV = $('#evalPV');
        const $btnCalculate = $('#btnCalculate');
        const $btnStop = $('#btnStop');
        const $turnSelect = $('#turnSelect');

        // --- STOCKFISH ENGINE INTEGRATION ---
        // We use Stockfish compiled to WebAssembly/JS. This leverages your personal computer's hardware
        // to provide Grandmaster-level (3000+ ELO) analysis, vastly outperforming custom JS logic.
        function initEngine() {
            if (engineWorker) return;
            
            // Load Stockfish 10 via CDN using a Blob to bypass cross-origin worker restrictions
            const blob = new Blob([
                "importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');"
            ], {type: 'application/javascript'});
            
            engineWorker = new Worker(URL.createObjectURL(blob));
            
            engineWorker.onmessage = function(event) {
                const msg = event.data;
                if (typeof msg !== 'string') return;

                // Parse real-time UCI Info
                if (msg.startsWith('info depth')) {
                    const depthMatch = msg.match(/depth (\d+)/);
                    const cpMatch = msg.match(/score cp (-?\d+)/);
                    const mateMatch = msg.match(/score mate (-?\d+)/);
                    const pvMatch = msg.match(/ pv (.*)/);

                    if (depthMatch) $evalDepth.text(depthMatch[1]);
                    
                    if (cpMatch) {
                        let score = parseInt(cpMatch[1]);
                        // Stockfish score is relative to the side to move. Convert to absolute (+ White, - Black)
                        if (game.turn() === 'b') score = -score;
                        const val = (score / 100).toFixed(2);
                        $evalScore.text(val > 0 ? '+' + val : val);
                    } else if (mateMatch) {
                        let mateIn = parseInt(mateMatch[1]);
                        let mateText = mateIn > 0 ? '+M' + mateIn : '-M' + Math.abs(mateIn);
                        if (game.turn() === 'b') {
                            mateText = mateIn > 0 ? '-M' + mateIn : '+M' + Math.abs(mateIn);
                        }
                        $evalScore.text(mateText);
                    }

                    if (pvMatch) {
                        $evalPV.text(pvMatch[1]);
                        const bestMoveUCI = pvMatch[1].split(' ')[0];
                        $evalBestMove.text(bestMoveUCI);
                        
                        const from = bestMoveUCI.substring(0, 2);
                        const to = bestMoveUCI.substring(2, 4);
                        highlightBestMove({from, to});
                    }
                }

                // Execution finished
                if (msg.startsWith('bestmove')) {
                    isCalculating = false;
                    $engineStatus.html('<i class="fa-solid fa-check text-green-500 mr-1"></i> Calculation complete.');
                    $btnCalculate.removeClass('hidden');
                    $btnStop.addClass('hidden');

                    const moveMatch = msg.match(/bestmove ([a-h][1-8][a-h][1-8][qrbn]?)/);
                    if (moveMatch) {
                        const uciMove = moveMatch[1];
                        const from = uciMove.substring(0, 2);
                        const to = uciMove.substring(2, 4);
                        const promotion = uciMove.length === 5 ? uciMove[4] : undefined;
                        
                        const turn = game.turn();
                        const autoPlay = $('#autoPlaySide').val();
                        
                        if (autoPlay === 'both' || autoPlay === turn) {
                            game.move({ from, to, promotion });
                            board.position(game.fen());
                            updateStatus();
                            removeHighlights();
                            setTimeout(checkAutoActions, 200);
                        }
                    }
                }
            };

            engineWorker.postMessage('uci');
            engineWorker.postMessage('isready');
        }

        // Initialize App
        function init() {
            initEngine(); // Start loading engine immediately
            board = Chessboard('board', {
                draggable: true,
                position: 'start',
                dropOffBoard: 'trash',
                sparePieces: true,
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
            updateStatus();
            setupEventListeners();
        }

        // Board Event Handlers
        function onDragStart(source, piece, position, orientation) {
            return true;
        }

        function onDrop(source, target, piece, newPos, oldPos, orientation) {
            removeHighlights();

            if (target === 'offboard') {
                game.remove(source);
                syncGameAfterEdit();
                return;
            }

            if (source === 'spare') {
                const pColor = piece[0];
                const pType = piece[1].toLowerCase();
                const success = game.put({ type: pType, color: pColor }, target);
                if (!success) return 'snapback';
                syncGameAfterEdit();
                return;
            }

            let move = game.move({ from: source, to: target, promotion: 'q' });

            if (move === null) {
                if (!$('#enforceRules').is(':checked')) {
                    const p = game.remove(source);
                    if (p) {
                        const success = game.put(p, target);
                        if (!success) {
                            game.put(p, source);
                            return 'snapback';
                        }
                        syncGameAfterEdit();
                        return;
                    }
                } else {
                    return 'snapback';
                }
            }

            updateStatus();
            checkAutoActions();
        }

        function syncGameAfterEdit() {
            const currentFen = game.fen();
            const tempGame = new Chess();
            if (tempGame.load(currentFen)) {
                game.load(currentFen);
            }
            updateStatus();
            checkAutoActions();
        }

        function onSnapEnd() {
            board.position(game.fen());
        }

        function updateStatus() {
            let status = '';
            let moveColor = game.turn() === 'w' ? 'White' : 'Black';

            try {
                if (game.in_checkmate()) {
                    status = `Game over, ${moveColor} is in checkmate.`;
                } else if (game.in_draw()) {
                    status = 'Game over, drawn position';
                } else {
                    status = `${moveColor} to move`;
                    if (game.in_check()) status += ', ' + moveColor + ' is in check';
                }
            } catch (error) {
                status = `Edit Mode: ${moveColor} to move (Invalid State)`;
            }

            $status.html(status);
            $fenInput.val(game.fen());
            $turnSelect.val(game.turn());
        }

        function checkAutoActions() {
            const turn = game.turn();
            const autoCalc = $('#autoCalcSide').val();
            const autoPlay = $('#autoPlaySide').val();

            let shouldCalculate = false;
            if (autoCalc === 'both' || autoCalc === turn) shouldCalculate = true;
            if (autoPlay === 'both' || autoPlay === turn) shouldCalculate = true;

            let isGameOver = true;
            try { isGameOver = game.game_over(); } catch(e) {}

            if (shouldCalculate && !isGameOver) {
                setTimeout(() => { if (!isCalculating) startEngineCalculation(); }, 200);
            } else {
                resetEngineUI();
            }
        }

        function removeHighlights() {
            $('#board .square-55d63').removeClass('highlight-white highlight-black highlight-best-from highlight-best-to');
        }

        function highlightBestMove(move) {
            removeHighlights();
            if(!move) return;
            $('#board .square-' + move.from).addClass('highlight-best-from');
            $('#board .square-' + move.to).addClass('highlight-best-to');
        }

        function resetEngineUI() {
            $engineStatus.html("Idle. Click 'Calculate' or make a move.");
            $evalScore.text('-');
            $evalDepth.text('-');
            $evalBestMove.text('-');
            $evalPV.text('-');
            removeHighlights();
            stopEngine();
        }

        function stopEngine() {
            if (engineWorker && isCalculating) {
                engineWorker.postMessage('stop');
            }
            isCalculating = false;
            $btnCalculate.removeClass('hidden');
            $btnStop.addClass('hidden');
        }

        function startEngineCalculation() {
            let isGameOver = true;
            try { isGameOver = game.game_over(); } catch(e) {}
            if (isGameOver) return;

            initEngine();

            stopEngine(); // Interrupt previous search
            isCalculating = true;
            $btnCalculate.addClass('hidden');
            $btnStop.removeClass('hidden');
            $engineStatus.html('<div class="loader"></div> Calculating (Stockfish 10 WASM)...');
            
            const thinkSeconds = parseFloat($('#thinkTime').val()) || 3;
            
            // Send position and tell Stockfish to compute
            engineWorker.postMessage('position fen ' + game.fen());
            engineWorker.postMessage('go movetime ' + (thinkSeconds * 1000));
        }

        function setupEventListeners() {
            $('#turnSelect').on('change', function() {
                const currentFen = game.fen();
                const parts = currentFen.split(' ');
                parts[1] = $(this).val();
                parts[3] = '-';
                parts[4] = '0';
                
                if (game.load(parts.join(' '))) {
                    updateStatus();
                    checkAutoActions();
                } else {
                    $turnSelect.val(game.turn());
                    alert("Cannot change turn while the board is in an invalid state.");
                }
            });

            $('#btnStart').on('click', () => {
                game.reset();
                board.position(game.fen());
                updateStatus();
                resetEngineUI();
                checkAutoActions();
            });

            $('#btnClear').on('click', () => {
                game.clear();
                board.clear();
                updateStatus();
                resetEngineUI();
            });

            $('#btnFlip').on('click', () => {
                board.flip();
            });

            $('#btnSetFen').on('click', () => {
                const fen = $('#customFen').val().trim();
                if (game.load(fen)) {
                    board.position(fen);
                    $('#fenError').addClass('hidden');
                    updateStatus();
                    resetEngineUI();
                    checkAutoActions();
                } else {
                    $('#fenError').removeClass('hidden');
                }
            });

            $btnCalculate.on('click', startEngineCalculation);
            $btnStop.on('click', () => {
                stopEngine();
                $engineStatus.html('<i class="fa-solid fa-stop text-red-500 mr-1"></i> Calculation stopped.');
            });

            $('#autoCalcSide, #autoPlaySide, #thinkTime').on('change', () => {
                if (!isCalculating) checkAutoActions();
            });

            $(window).resize(() => {
                if(board) board.resize();
            });
        }

        $(document).ready(init);

    </script>
</body>
</html>
